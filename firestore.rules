rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isSignedIn() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'government_official';
    }

    // Users collection - authenticated users can read any user profile, only write own
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    // Reports collection - authenticated users can read, anyone can create
    match /reports/{reportId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() &&
                       (request.auth.uid == resource.data.reportedBy || isAdmin());
      allow delete: if isAdmin();

      // Comments subcollection within reports
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
        allow delete: if isSignedIn() && (request.auth.uid == resource.data.userId || isAdmin());
      }
    }

    // Categories collection - authenticated users can read, only authenticated users can create
    match /report-categories/{categoryId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
     // Activity Logs collection - read-only for authenticated users, system writes only
    match /activity_logs/{logId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn(); // Allow authenticated users to create logs
      allow update: if false; // Activity logs are immutable
      allow delete: if isAdmin(); // Only admins can delete logs (for cleanup)
    }

    // Comments collection (top-level, for backwards compatibility)
    match /comments/{commentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if isSignedIn() && (request.auth.uid == resource.data.userId || isAdmin());
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // Report Votes collection - for upvote/downvote functionality
    match /reportVotes/{voteId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // Analytics collection - only admins
    match /analytics/{analyticsId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Departments collection - authenticated users can read, only admins can write
    match /departments/{departmentId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Votes collection (legacy, for backwards compatibility)
    match /votes/{voteId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // Feedback collection
    match /feedback/{feedbackId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
    }
  }
}
