# Report Data Consistency Guide

## Overview

This guide explains the data flow for report submissions in the Ayos mobile app and how to maintain consistency when modifying data structures.

---

## Data Flow Architecture

```
User Input (IssueReportingWizard)
    ↓
AI Analysis (groqServices.ts)
    ↓
AIAnalysis Interface (types/reporting.ts)
    ↓
Review Display (ReviewSubmitStep.tsx)
    ↓
Report Submission (IssueReportingWizard → submitReport)
    ↓
Firebase Firestore Database (services/reports.js)
```

---

## Core Type Definitions

### Location: `types/reporting.ts`

This is the **single source of truth** for all report-related data structures.

### Key Interfaces:

1. **`AIAnalysis`** - AI-generated analysis data

   - Used by: `groqServices.ts`, `IssueReportingWizard.tsx`, `ReviewSubmitStep.tsx`
   - Fields:
     - `category`: IssueCategory enum
     - `subcategory`: string
     - `summary`: string (brief summary of issue)
     - `title`: string (AI-generated short title for table view)
     - `department`: string (optional, assigned department)
     - `priority`: IssuePriority enum
     - `suggested_actions`: string[]
     - `keywords`: string[]
     - `location`: string (extracted location)
     - `urgency_assessment`: string

2. **`ReportData`** - Final report data submitted to Firebase
   - Used by: `IssueReportingWizard.tsx`, `reports.js`
   - Fields:
     - `description`: string
     - `aiAnalysis`: AIAnalysis | null
     - `timestamp`: string
     - `location`: object (latitude, longitude, address, city, province, country)
     - `images`: string[] (Firebase Storage URLs)

---

## When Adding/Modifying Fields in `types/reporting.ts`

### Step-by-Step Checklist:

#### 1. **Modify Type Definition** (`types/reporting.ts`)

```typescript
export interface AIAnalysis {
  // ... existing fields
  newField?: string; // Add your new field
}
```

#### 2. **Update AI Service Layer** (`services/groqServices.ts`)

**Files to check:**

- `analyzeIssueWithAI()` - Groq AI analysis function
- `analyzeWithGemini()` - Gemini fallback function

**What to update:**

```typescript
const result: AIAnalysis = {
  category: mapToIssueCategory(parsedResponse.category),
  subcategory: parsedResponse.subcategory,
  // ... other fields
  newField: parsedResponse.newField || "default value", // ADD THIS
};
```

**Important considerations:**

- Add fallback values for when AI doesn't return the field
- Update the `SYSTEM_PROMPT` to instruct AI to include the new field
- Test both Groq and Gemini paths
- Add JSON parsing error handling if needed

#### 3. **Update Component State** (`components/IssueReportingWizard.tsx`)

**Key locations:**

a. **State management** (if needed):

```typescript
const [aiAnalysis, setAiAnalysis] = useState<AIAnalysis | null>(null);
```

b. **AI Analysis handler** (`handleAnalyzeWithAI`):

```typescript
const analysis = await analyzeIssueWithAI(userDescription);
// If you need to manipulate the new field:
const enhancedAnalysis = { ...analysis, newField: processedValue };
setAiAnalysis(enhancedAnalysis);
```

c. **Report submission** (`handleConfirm`):

```typescript
const reportData = {
  title: aiAnalysis?.title || fallback,
  description: userDescription,
  category: aiAnalysis?.category || "other",
  // ... other fields
  newField: aiAnalysis?.newField || defaultValue, // ADD THIS
  aiAnalysis: aiAnalysis, // Full analysis is also stored
};
```

#### 4. **Update Review Display** (`components/ReviewSubmitStep.tsx`)

**Add UI display for the new field:**

```tsx
<View style={styles.summaryItem}>
  <Text style={styles.summaryLabel}>New Field:</Text>
  <Text style={styles.summaryValue}>
    {aiAnalysis?.newField || "Not specified"}
  </Text>
</View>
```

**Common display patterns:**

- Priority colors: Use `getPriorityColor()` helper
- Department assignment: Use `getAssignedDepartment()` helper
- Arrays: Map through items with proper styling
- Optional fields: Always provide fallback text

#### 5. **Update Firebase Service** (`services/reports.js`)

**Check `submitReport()` function:**

```javascript
const baseReportData = {
  ...otherData,
  createdAt: serverTimestamp(),
  updatedAt: serverTimestamp(),
  status: "submitted",
  newField: reportData.newField, // Explicitly add if needed
  ...(userId && { reportedBy: userId }),
  ...(userEmail && { userEmail: userEmail }),
};
```

**Important:**

- Firebase stores JavaScript objects directly
- No schema enforcement - be careful with field naming
- The entire `reportData` object is spread, so most fields auto-include
- Explicitly add fields that need transformation or special handling

---

## Special Cases & Considerations

### 1. **AI-Generated Fields**

If the field is generated by AI (like `title`):

- Generate in `handleAnalyzeWithAI()` immediately after AI analysis
- Store in `aiAnalysis` object for consistency
- Example: `title` is generated from `summary` and stored in `aiAnalysis`

```typescript
const analysis = await analyzeIssueWithAI(userDescription);
const title = await generateReportTitle(analysis.summary);
const analysisWithTitle = { ...analysis, title };
setAiAnalysis(analysisWithTitle);
```

### 2. **Enum Fields**

For enums like `IssueCategory` or `IssuePriority`:

- Define enum in `types/reporting.ts`
- Create mapping function in `groqServices.ts`:
  ```typescript
  const mapToIssueCategory = (category: string): IssueCategory => {
    // ... mapping logic
  };
  ```
- Use enum values consistently across all components

### 3. **Optional vs Required Fields**

- Use `?` for optional fields: `title?: string`
- Always provide fallbacks when accessing: `aiAnalysis?.title || "fallback"`
- Consider UI implications - show "Not specified" or hide field entirely

### 4. **Nested Objects**

For complex nested data like `location`:

- Define structure in `ReportData` interface
- Handle null/undefined carefully with optional chaining
- Example: `reportData.location?.address`

### 5. **Arrays**

For array fields like `keywords` or `suggested_actions`:

- Provide empty array fallback: `aiAnalysis?.keywords || []`
- Check length before mapping in UI
- Consider maximum length limits for display

---

## Common Pitfalls & Solutions

### ❌ Problem: Field added to interface but not in AI response

**Solution:** Update `SYSTEM_PROMPT` and add fallback value in result mapping

### ❌ Problem: TypeScript errors after adding field

**Solution:** Update ALL locations where `AIAnalysis` is constructed (both Groq and Gemini)

### ❌ Problem: Field doesn't appear in Firebase

**Solution:** Check if field is in `reportData` object in `handleConfirm()`

### ❌ Problem: Field shows "undefined" in UI

**Solution:** Add fallback: `aiAnalysis?.field || "default value"`

### ❌ Problem: Field works locally but not after reload

**Solution:** Ensure field is stored in Firebase and retrieved in `getUserReports()`

---

## Testing Checklist

When modifying report data structures, test:

- [ ] AI analysis (Groq path) includes new field
- [ ] AI analysis (Gemini fallback) includes new field
- [ ] Field displays correctly in ReviewSubmitStep
- [ ] Field saves to Firebase successfully
- [ ] Field retrieves correctly from Firebase
- [ ] TypeScript compiles without errors
- [ ] Fallback values work when AI fails
- [ ] Optional chaining prevents crashes

---

## File Dependency Map

```
types/reporting.ts (SOURCE OF TRUTH)
    ↓
    ├── services/groqServices.ts
    │   ├── analyzeIssueWithAI()
    │   ├── analyzeWithGemini()
    │   └── generateReportTitle()
    │
    ├── components/IssueReportingWizard.tsx
    │   ├── State: aiAnalysis
    │   ├── handleAnalyzeWithAI()
    │   └── handleConfirm() → reportData
    │
    ├── components/ReviewSubmitStep.tsx
    │   └── Display aiAnalysis fields
    │
    └── services/reports.js
        └── submitReport() → Firebase
```

---

## Quick Reference: Field Addition Flow

1. Add to `AIAnalysis` interface in `types/reporting.ts`
2. Update `SYSTEM_PROMPT` in `groqServices.ts` (if AI should generate it)
3. Add to result mapping in `analyzeIssueWithAI()` (line ~64)
4. Add to result mapping in `analyzeWithGemini()` (line ~165)
5. Add to `reportData` in `handleConfirm()` (line ~126)
6. Add UI display in `ReviewSubmitStep.tsx` (line ~180+)
7. Verify Firebase storage in `submitReport()` (optional)
8. Test both AI paths and fallbacks

---

## Contact & Updates

- Last Updated: November 23, 2025
- Project: Ayos Mobile (Citizen Reporting App)
- Tech Stack: React Native, Expo, TypeScript, Firebase, Groq AI, Google Gemini
